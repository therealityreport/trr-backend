# Mermaid Diagram

```mermaid
graph TD
    %% Repository Structure
    subgraph trr_backend
        root[trr-backend]
        subgraph claude[CLAUDE]
            claude_cmd[commands]
            claude_hook[hooks]
            claude_cmd --> trr_impl[trr-impl.md]
            claude_cmd --> trr_plan[trr-plan.md]
            claude_cmd --> trr_pr[trr-pr.md]
            claude_cmd --> trr_spec[trr-spec.md]
            claude_cmd --> trr_validate[trr-validate.md]
            claude_cmd --> trr_wt_new[trr-wt-new.md]
            claude_hook --> before_bash[before-bash.md]
            claude_hook --> on_stop[on-stop.md]
        end
        subgraph config[CONFIG]
            config_file[.config]
            config_file --> wt[wt.toml]
        end
        root --> env[.env.example]
        subgraph github[.github]
            workflows[workflows]
            workflows --> ci[ci.yml]
            workflows --> repo_map[repo_map.yml]
        end
        root --> gitignore[.gitignore]
        root --> python_version[.python-version]
        root --> CLAUDE[CLAUDE.md]
        root --> Makefile[Makefile]
        root --> README[README.md]
        root --> REPO_STRUCTURE[REPO_STRUCTURE.md]
        
        subgraph api[API]
            __init__[__init__.py]
            auth[auth.py]
            deps[deps.py]
            main[main.py]
            subgraph realtime[realtime]
                r_init[__init__.py]
                broker[broker.py]
                events[events.py]
            end
            subgraph routers[routers]
                r_init_routers[__init__.py]
                discussions[discussions.py]
                dms[dms.py]
                shows[shows.py]
                surveys[surveys.py]
                ws[ws.py]
            end
        end

        root --> backfill_script[backfill_tmdb_show_details.py]
        
        subgraph docs[DOCUMENTATION]
            history_purge[HISTORY_PURGE.md]
            readme_local[README_local.md]
            subgraph repository[Repository]
                repo_readme[README.md]
                subgraph diagrams[diagrams]
                    git_workflow[git_workflow.md]
                    system_maps[system_maps.md]
                end
                subgraph generated[generated]
                    g_gitkeep[.gitkeep]
                    g_code_import_graph[CODE_IMPORT_GRAPH.md]
                    g_repo_structure[REPO_STRUCTURE.md]
                    g_repo_structure_mermaid[REPO_STRUCTURE.mermaid.md]
                    g_scripts_flow[SCRIPTS_FLOW.md]
                    subgraph rendered[rendered]
                        r_code_import_graph[CODE_IMPORT_GRAPH-1.svg]
                        r_scripts_flow[SCRIPTS_FLOW-1.svg]
                        r_git_workflow[git_workflow-1.svg]
                        r_system_maps[system_maps-1.svg]
                        r_system_maps2[system_maps-2.svg]
                    end
                end
            end
            sheet_edit_mapping[SHEET_EDIT_MAPPING.md]
            subgraph api_docs[api]
                run[run.md]
            end
            subgraph architecture[architecture]
                integrations[integrations.md]
            end
            architecture_main[architecture.md]
            subgraph cloud[cloud]
                cloud_setup[cloud_setup.md]
                quick_cloud_setup[quick_cloud_setup.md]
                setup_codespaces_credentials[setup_codespaces_credentials.md]
            end
            subgraph db[database]
                commands[commands.md]
                schema[schema.md]
                verification[verification.md]
            end
            images[images]
            debug_image[debug_imdb_credits.png]
            subgraph runbooks[runbooks]
                show_import_job[show_import_job.md]
            end
            subgraph workflows_docs[workflows]
                vibe_coding[VIBE_CODING.md]
            end
        end

        root --> pytest[pytest.ini]
        root --> requirements[requirements.txt]
        root --> resolve_tmdb[resolve_tmdb_ids_via_find.py]
        root --> ruff[ruff.toml]
        
        subgraph scripts[SCRIPTS]
            media[Media]
            media_readme[README.md]
            sync_common[_sync_common.py]
            backfill_script[backfill_tmdb_show_details.py]
            subgraph db_scripts[db]
                db_readme[README.md]
                guard_core_schema[guard_core_schema.sql]
                reload_postgrest_schema[reload_postgrest_schema.sql]
                run_sql[run_sql.sh]
                verify_pre_0033_cleanup[verify_pre_0033_cleanup.sql]
            end
            enrich_show_cast[enrich_show_cast.py]
            generate_repo_mermaid[generate_repo_mermaid.py]
            imdb_show_enrichment[imdb_show_enrichment.py]
            import_fandom_gallery_photos[import_fandom_gallery_photos.py]
            import_imdb_cast_episode_appearances[import_imdb_cast_episode_appearances.py]
            import_shows_from_lists[import_shows_from_lists.py]
            mirror_cast_photos_to_s3[mirror_cast_photos_to_s3.py]
            mirror_show_images_to_s3[mirror_show_images_to_s3.py]
            rebuild_hosted_urls[rebuild_hosted_urls.py]
            resolve_tmdb_ids_via_find[resolve_tmdb_ids_via_find.py]
            rhoslc_fandom_enrichment[rhoslc_fandom_enrichment.py]
            run_pipeline[run_pipeline.py]
            run_show_import_job[run_show_import_job.py]
            subgraph supabase_scripts[supabase]
                generate_schema_docs[generate_schema_docs.py]
            end
            sync_all_tables[sync_all_tables.py]
            sync_cast_photos[sync_cast_photos.py]
            sync_episode_appearances[sync_episode_appearances.py]
            sync_episodes[sync_episodes.py]
            sync_people[sync_people.py]
            sync_season_episode_images[sync_season_episode_images.py]
            sync_seasons[sync_seasons.py]
            sync_seasons_episodes[sync_seasons_episodes.py]
            sync_show_cast[sync_show_cast.py]
            sync_show_images[sync_show_images.py]
            sync_shows[sync_shows.py]
            sync_shows_all[sync_shows_all.py]
            sync_tmdb_person_images[sync_tmdb_person_images.py]
            sync_tmdb_show_entities[sync_tmdb_show_entities.py]
            sync_tmdb_watch_providers[sync_tmdb_watch_providers.py]
            verify_schema[verify_schema.py]
        end

        subgraph skills[SKILLS]
            db_designer[database-designer]
            db_designer_file[SKILL.md]
            references[references]
            examples[examples.md]
            playbooks[playbooks.md]
            repo_context[repo-context.md]
            templates[templates.sql]
            tooling[tooling.md]
        end

        subgraph supabase_db[SUPABASE]
            supabase_gitignore[.gitignore]
            supabase_config[config.toml]
            subgraph migrations[MIGRATIONS]
                migration_1[0001_init.sql]
                migration_2[0002_social.sql]
                migration_3[0003_dms.sql]
                migration_4[0004_core_shows.sql]
                migration_5[0005_show_images.sql]
                migration_6[0006_show_images_grants.sql]
                migration_7[0007_core_shows_tmdb_id.sql]
                migration_8[0008_show_images_tmdb_id.sql]
                migration_9[0009_show_images_view.sql]
                migration_10[0010_show_images_no_votes.sql]
                migration_11[0011_show_images_view_no_votes.sql]
                migration_12[0012_seasons_and_episodes.sql]
                migration_13[0013_season_images.sql]
                migration_14[0014_show_seasons_view.sql]
                migration_15[0015_seasons_show_name.sql]
                migration_16[0016_seasons_episode_id_arrays.sql]
                migration_17[0017_episodes_show_name.sql]
                migration_18[0018_imdb_cast_episode_appearances.sql]
                migration_19[0019_imdb_cast_grants.sql]
                migration_20[0020_reorder_show_tables.sql]
                migration_21[0021_reorder_people_cast_seasons_episodes.sql]
                migration_22[0022_episode_appearances_export_view.sql]
                migration_23[0023_episode_appearances_export_view_total_episodes.sql]
                migration_24[0024_episode_appearances_aggregate.sql]
                migration_25[0025_sync_state.sql]
                migration_26[0026_add_imdb_meta_to_core_shows.sql]
                migration_27[0027_show_images_media_sources.sql]
                migration_28[0028_normalize_shows_add_columns.sql]
                migration_29[0029_create_source_tables.sql]
                migration_30[0030_create_normalized_child_tables.sql]
                migration_31[0031_update_show_images_typed.sql]
                migration_32[0032_backfill_normalized_data.sql]
                migration_33[0033_cleanup_legacy_jsonb_columns.sql]
                migration_34[0034_show_images_constraints_and_show_flags.sql]
                migration_35[0035_show_images_upsert_rpc.sql]
                migration_36[0036_show_merge_helpers.sql]
                migration_37[0037_collapse_show_attributes.sql]
                migration_38[0038_update_merge_shows_arrays.sql]
                migration_39[0039_drop_child_tables.sql]
                migration_40[0040_create_cast_photos.sql]
                migration_41[0041_create_cast_fandom_and_extend_cast_photos.sql]
                migration_42[0042_revoke_cast_public_access.sql]
                migration_43[0043_cast_photos_add_hosted_fields.sql]
                migration_44[0044_create_cast_tmdb.sql]
                migration_45[0045_show_images_add_hosted_fields.sql]
                migration_46[0046_cast_photos_allow_tmdb_source.sql]
                migration_47[0047_add_show_source_metadata.sql]
                migration_48[0048_create_tmdb_entities_and_watch_providers.sql]
                migration_49[0049_rename_tmdb_dimension_tables.sql]
                migration_50[0050_drop_or_view_tmdb_imdb_series.sql]
                migration_51[0051_season_images_add_hosted_fields.sql]
            end
            subgraph schema_docs[SCHEMA_DOCUMENTATION]
                index[INDEX.md]
                core_cast_fandom[core.cast_fandom.json]
                core_cast_fandom_md[core.cast_fandom.md]
                core_cast_memberships[core.cast_memberships.json]
                core_cast_memberships_md[core.cast_memberships.md]
                core_cast_photos[core.cast_photos.json]
                core_cast_photos_md[core.cast_photos.md]
                core_cast_tmdb[core.cast_tmdb.json]
                core_cast_tmdb_md[core.cast_tmdb.md]
                core_episode_appearances[core.episode_appearances.json]
                core_episode_appearances_md[core.episode_appearances.md]
                core_episode_cast[core.episode_cast.json]
                core_episode_cast_md[core.episode_cast.md]
                core_episodes[core.episodes.json]
                core_episodes_md[core.episodes.md]
                core_networks[core.networks.json]
                core_networks_md[core.networks.md]
                core_people[core.people.json]
                core_people_md[core.people.md]
                core_production_companies[core.production_companies.json]
                core_production_companies_md[core.production_companies.md]
                core_season_images[core.season_images.json]
                core_season_images_md[core.season_images.md]
                core_seasons[core.seasons.json]
                core_seasons_md[core.seasons.md]
                core_show_cast[core.show_cast.json]
                core_show_cast_md[core.show_cast.md]
                core_show_images[core.show_images.json]
                core_show_images_md[core.show_images.md]
                core_show_watch_providers[core.show_watch_providers.json]
                core_show_watch_providers_md[core.show_watch_providers.md]
                core_shows[core.shows.json]
                core_shows_md[core.shows.md]
                core_sync_state[core.sync_state.json]
                core_sync_state_md[core.sync_state.md]
                core_watch_providers[core.watch_providers.json]
                core_watch_providers_md[core.watch_providers.md]
            end
            seed[seed.sql]
        end
        
        root --> test_connection[test_connection.py]
        
        subgraph tests[TESTS]
            __init_t[__init__.py]
            subgraph fixtures[fixtures]
                fandom[fandom]
                lisa_barlow_infobox[lisa_barlow_infobox.html]
                lisa_barlow_person_sample[lisa_barlow_person_sample.html]
                imdb[imdb]
                episodes_page_overview_one_season_sample[episodes_page_overview_one_season_sample.html]
                episodes_page_overview_sample[episodes_page_overview_sample.html]
                episodes_page_season1_next_data_sample[episodes_page_season1_next_data_sample.html]
                episodes_page_season3_sample[episodes_page_season3_sample.html]
                fullcredits_cast_sample[fullcredits_cast_sample.html]
                list_html_fallback_sample[list_html_fallback_sample.html]
                list_jsonld_sample[list_jsonld_sample.html]
                list_sample[list_sample.html]
                list_sample_page2[list_sample_page2.html]
                mediaindex_tt8819906_sample[mediaindex_tt8819906_sample.html]
                mediaindex_viewer_graphql_tt8819906_sample[mediaindex_viewer_graphql_tt8819906_sample.html]
                person_mediaindex_nm11883948_sample[person_mediaindex_nm11883948_sample.html]
                person_mediaviewer_nm11883948_rm1679992066_sample[person_mediaviewer_nm11883948_rm1679992066_sample.html]
                section_images_sample[section_images_sample.html]
                title_list_main_page_sample[title_list_main_page_sample.json]
                title_page_sample[title_page_sample.html]
                title_page_tt8819906_sample[title_page_tt8819906_sample.html]
                end
            end
            subgraph ingestion[ingestion]
                test_episode_appearances_upsert[test_episode_appearances_upsert.py]
                test_fandom_person_scraper[test_fandom_person_scraper.py]
                test_show_importer_metadata_enrichment[test_show_importer_metadata_enrichment.py]
                test_show_importer_tmdb_details_links_imdb_show[test_show_importer_tmdb_details_links_imdb_show.py]
                test_show_metadata_enricher[test_show_metadata_enricher.py]
                test_tmdb_show_backfill[test_tmdb_show_backfill.py]
            end
            subgraph integrations[integrations]
                fandom[fandom]
                test_fandom_infobox_parser[test_fandom_infobox_parser.py]
                imdb[imdb]
                test_episodic_client_normalization[test_episodic_client_normalization.py]
                test_fullcredits_cast_parser[test_fullcredits_cast_parser.py]
                test_imdb_episodes_persistence[test_imdb_episodes_persistence.py]
                test_imdb_images[test_imdb_images.py]
                test_imdb_list_graphql_client_parsing[test_imdb_list_graphql_client_parsing.py]
                test_mediaindex_images[test_mediaindex_images.py]
                test_person_gallery_parser[test_person_gallery_parser.py]
                test_title_page_metadata[test_title_page_metadata.py]
            end
            subgraph tmdb[tmdb]
                test_tmdb_season_enrichment[test_tmdb_season_enrichment.py]
                test_tmdb_tv_details_persistence[test_tmdb_tv_details_persistence.py]
                test_tmdb_tv_images_persistence[test_tmdb_tv_images_persistence.py]
            end
            media[media]
            test_s3_mirror[test_s3_mirror.py]
            migrations[migrations]
            test_show_source_metadata_migrations[test_show_source_metadata_migrations.py]
            subgraph repositories[repositories]
                test_cast_photos_upsert[test_cast_photos_upsert.py]
                test_pgrst204_retry[test_pgrst204_retry.py]
                test_shows_preflight[test_shows_preflight.py]
            end
            subgraph scripts_tests[scripts]
                test_import_shows_from_lists_merge[test_import_shows_from_lists_merge.py]
                test_import_shows_from_lists_parsing[test_import_shows_from_lists_parsing.py]
                test_import_shows_from_lists_upsert[test_import_shows_from_lists_upsert.py]
                test_sync_incremental[test_sync_incremental.py]
                test_sync_tmdb_watch_providers[test_sync_tmdb_watch_providers.py]
            end
            test_api_smoke[test_api_smoke.py]
            test_discussions_smoke[test_discussions_smoke.py]
            test_dms_smoke[test_dms_smoke.py]
            test_ws_realtime_smoke[test_ws_realtime_smoke.py]
            subgraph utils[utils]
                test_episode_appearances_aggregation[test_episode_appearances_aggregation.py]
            end
        end
        
        subgraph trr_backend_code[TRR_BACKEND]
            init[__init__.py]
            subgraph db[db]
                db_init[__init__.py]
                connection[connection.py]
                postgrest_cache[postgrest_cache.py]
                preflight[preflight.py]
                show_images[show_images.py]
                supabase[supabase.py]
            end
            subgraph ingestion_code[ingestion]
                ingestion_init[__init__.py]
                cast_photo_sources[cast_photo_sources.py]
                fandom_person_scraper[fandom_person_scraper.py]
                imdb_images[imdb_images.py]
                show_importer[show_importer.py]
                show_metadata_enricher[show_metadata_enricher.py]
                showinfo_overrides[showinfo_overrides.py]
                shows_from_lists[shows_from_lists.py]
                tmdb_person_images[tmdb_person_images.py]
                tmdb_show_backfill[tmdb_show_backfill.py]
            end
            subgraph integrations_code[integrations]
                integrations_init[__init__.py]
                fandom[fandom.py]
                subgraph imdb_code[imdb]
                    imdb_init[__init__.py]
                    credits_client[credits_client.py]
                    episodic_client[episodic_client.py]
                    fullcredits_cast_parser[fullcredits_cast_parser.py]
                    list_graphql_client[list_graphql_client.py]
                    mediaindex_images[mediaindex_images.py]
                    person_gallery[person_gallery.py]
                    title_metadata_client[title_metadata_client.py]
                    title_page_metadata[title_page_metadata.py]
                end
                subgraph tmdb_integration[tmdb]
                    tmdb_init[__init__.py]
                    client[client.py]
                end
                tmdb_person[tmdb_person.py]
            end
            subgraph media_code[media]
                media_init[__init__.py]
                s3_mirror[s3_mirror.py]
            end
            subgraph models[models]
                models_init[__init__.py]
                cast_photos[cast_photos.py]
                shows[shows.py]
            end
            subgraph repositories_code[repositories]
                repositories_init[__init__.py]
                cast_fandom[cast_fandom.py]
                cast_photos[cast_photos.py]
                cast_tmdb[cast_tmdb.py]
                episode_appearances[episode_appearances.py]
                episodes[episodes.py]
                imdb_series[imdb_series.py]
                people[people.py]
                season_images[season_images.py]
                seasons[seasons.py]
                show_cast[show_cast.py]
                show_images[show_images.py]
                shows[shows.py]
                sync_state[sync_state.py]
                tmdb_series[tmdb_series.py]
            end
            subgraph utils_code[utils]
                utils_init[__init__.py]
                env[env.py]
                episode_appearances[episode_appearances.py]
            end
        end
    end
    style trr_backend fill:#e0f7fa,stroke:#333,stroke-width:2px;
    style claude fill:#ffe082,stroke:#333,stroke-width:2px;
    style config fill:#c8e6c9,stroke:#333,stroke-width:2px;
    style github fill:#bbdefb,stroke:#333,stroke-width:2px;
    style api fill:#ef9a9a,stroke:#333,stroke-width:2px;
    style docs fill:#f0e68c,stroke:#333,stroke-width:2px;
    style scripts fill:#b2dfdb,stroke:#333,stroke-width:2px;
    style supabase_db fill:#ffccbc,stroke:#333,stroke-width:2px;
    style tests fill:#d1c4e9,stroke:#333,stroke-width:2px;
    style trr_backend_code fill:#e1bee7,stroke:#333,stroke-width:2px;
    style skills fill:#ffab91,stroke:#333,stroke-width:2px;
```